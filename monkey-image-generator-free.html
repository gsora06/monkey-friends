<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üêµ Monkey Image Gallery</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        h1 {
            text-align: center;
            color: #764ba2;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 1.2em;
        }

        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }

        .warning-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .input-group {
            flex: 1;
            min-width: 200px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        select:focus {
            outline: none;
            border-color: #667eea;
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            flex: 1;
            min-width: 200px;
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:active:not(:disabled) {
            transform: translateY(0);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            opacity: 0.6;
        }

        .special-btn {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .clear-btn {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }

        .gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .image-card {
            background: #f8f9fa;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.3s;
            animation: slideIn 0.5s ease-out;
            position: relative;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .image-card:hover {
            transform: scale(1.02);
        }

        .image-card img {
            width: 100%;
            height: 300px;
            object-fit: cover;
            display: block;
            cursor: pointer;
        }

        .image-info {
            padding: 15px;
            text-align: center;
        }

        .image-info h3 {
            color: #764ba2;
            margin-bottom: 8px;
            font-size: 1.3em;
        }

        .image-info .fun-fact {
            color: #666;
            font-size: 0.9em;
            font-style: italic;
            margin-top: 5px;
        }

        .image-actions {
            display: flex;
            gap: 8px;
            padding: 10px 15px;
            border-top: 1px solid #e0e0e0;
            background: #fff;
        }

        .action-btn {
            flex: 1;
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
        }

        .action-btn.favorite {
            background: #fff;
            border: 2px solid #764ba2;
            color: #764ba2;
        }

        .action-btn.favorite.active {
            background: #764ba2;
            color: white;
        }

        .action-btn.download {
            background: #4CAF50;
            color: white;
        }

        .action-btn.share {
            background: #2196F3;
            color: white;
        }

        .action-btn.delete {
            background: #f44336;
            color: white;
        }

        .action-btn:hover {
            opacity: 0.8;
            transform: scale(1.05);
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.5em;
            color: #764ba2;
        }

        .loading.hidden {
            display: none;
        }

        .spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #764ba2;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s ease;
        }

        .counter {
            text-align: center;
            font-size: 1.2em;
            color: #764ba2;
            font-weight: bold;
            margin-bottom: 15px;
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #323232;
            color: white;
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 2000;
            animation: slideInUp 0.3s ease-out;
            max-width: 350px;
        }

        .toast.success {
            background: #4CAF50;
        }

        .toast.error {
            background: #f44336;
        }

        .toast.warning {
            background: #ff9800;
        }

        @keyframes slideInUp {
            from {
                transform: translateY(100px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Modal for full-size images */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.95);
        }

        .modal.active {
            display: block;
        }

        .modal-content {
            margin: auto;
            display: block;
            max-width: 90%;
            max-height: 90%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            animation: zoomIn 0.3s ease-out;
        }

        @keyframes zoomIn {
            from {
                transform: translate(-50%, -50%) scale(0.7);
                opacity: 0;
            }
            to {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
        }

        .modal-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
        }

        .modal-btn {
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }

        .close {
            position: absolute;
            top: 20px;
            right: 20px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
            transition: all 0.2s;
        }

        .close:hover {
            background: rgba(255,255,255,0.2);
            transform: scale(1.1);
        }

        .favorites-section {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 2px solid #e0e0e0;
        }

        .section-title {
            font-size: 1.8em;
            color: #764ba2;
            margin-bottom: 20px;
            text-align: center;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
            font-style: italic;
        }

        /* Accessibility improvements */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0,0,0,0);
            white-space: nowrap;
            border-width: 0;
        }

        /* Focus indicators */
        button:focus-visible,
        select:focus-visible,
        .action-btn:focus-visible {
            outline: 3px solid #667eea;
            outline-offset: 2px;
        }

        .image-card:focus-within {
            box-shadow: 0 0 0 3px #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üêµ Monkey Photo Gallery üêµ</h1>
        <p class="subtitle">Beautiful real photos of monkeys from around the world!</p>

        <div class="info-box">
            <strong>100% Free!</strong> All photos come from Unsplash and Pexels - beautiful, professional monkey photography at no cost. Click any image to see it full-size!
        </div>

        <div class="warning-box">
            <strong>‚ö†Ô∏è Setup Required:</strong> To see real monkey photos, you need API keys:
            <ul style="margin: 10px 0 0 20px;">
                <li><strong>Unsplash:</strong> Get free key at <a href="https://unsplash.com/developers" target="_blank" style="color: #667eea;">unsplash.com/developers</a> (50 requests/hour free)</li>
                <li><strong>Pixabay:</strong> Get free key at <a href="https://pixabay.com/api/docs/" target="_blank" style="color: #667eea;">pixabay.com/api/docs</a></li>
            </ul>
            <p style="margin-top: 10px; font-size: 0.9em;">Update the <code>CONFIG</code> object in the JavaScript (line 549). Without keys, placeholder images will be shown.</p>
        </div>

        <div class="counter" id="counter" role="status" aria-live="polite">Images in gallery: 0 | Favorites: 0</div>

        <div class="controls">
            <div class="input-group">
                <label for="monkeyType">Choose a monkey type:</label>
                <select id="monkeyType" aria-label="Select monkey species">
                    <option value="macaque">Macaque</option>
                    <option value="japanese macaque">Japanese Macaque (Snow Monkey)</option>
                    <option value="rhesus macaque">Rhesus Macaque</option>
                    <option value="capuchin monkey">Capuchin Monkey</option>
                    <option value="spider monkey">Spider Monkey</option>
                    <option value="howler monkey">Howler Monkey</option>
                    <option value="marmoset">Marmoset</option>
                    <option value="tamarin">Golden Tamarin</option>
                    <option value="proboscis monkey">Proboscis Monkey</option>
                    <option value="monkey">Any Monkey (Random)</option>
                </select>
            </div>
        </div>

        <div class="button-group">
            <button id="loadSingleBtn" aria-label="Load one monkey image">üêµ Show Me a Monkey!</button>
            <button id="loadMultipleBtn" class="special-btn" aria-label="Load six random monkey images">‚ú® Show 6 Random Monkeys!</button>
            <button id="loadCollectionBtn" class="special-btn" aria-label="Load macaque collection">üé® Macaque Collection (5 photos)</button>
            <button id="clearGalleryBtn" class="clear-btn" aria-label="Clear all images from gallery">üóëÔ∏è Clear Gallery</button>
        </div>

        <div class="loading hidden" id="loadingMessage" role="alert" aria-live="polite">
            <div class="spinner"></div>
            <div id="loadingText">Loading monkey photos...</div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
        </div>

        <div class="gallery" id="gallery" role="list" aria-label="Monkey photo gallery"></div>

        <div class="favorites-section" id="favoritesSection" style="display: none;">
            <h2 class="section-title">‚≠ê Your Favorites</h2>
            <div class="gallery" id="favoritesGallery" role="list" aria-label="Favorite monkey photos"></div>
        </div>
    </div>

    <!-- Modal for full-size images -->
    <div id="imageModal" class="modal" role="dialog" aria-modal="true" aria-label="Full size image viewer">
        <div class="modal-controls">
            <button class="modal-btn" id="fullscreenBtn" aria-label="Toggle fullscreen" title="Fullscreen">‚õ∂</button>
            <button class="modal-btn" id="closeModalBtn" aria-label="Close modal" title="Close">√ó</button>
        </div>
        <img class="modal-content" id="modalImage" alt="Full size monkey photo">
    </div>

    <script>
        // Configuration
        const CONFIG = {
            unsplashKey: '_DEMO_KEY_', // Replace with your Unsplash Access Key
            pixabayKey: '9656065-a4094594c34f9ac14c7fc4c39', // Replace with your Pixabay API key
            requestDelay: 300 // Delay between parallel requests (ms)
        };

        const monkeyFacts = {
            'macaque': [
                'Macaques are very intelligent and can learn tricks!',
                'There are 23 different species of macaques',
                'Macaques love to play in groups',
                'Some macaques have cheek pouches to store food'
            ],
            'japanese macaque': [
                'Snow monkeys love to bathe in hot springs!',
                'They have the thickest fur of all monkeys',
                'They live in the coldest climate of any monkey',
                'Baby snow monkeys are born in spring'
            ],
            'rhesus macaque': [
                'Rhesus macaques are excellent swimmers',
                'They can recognize themselves in mirrors',
                'They live in large family groups',
                'They help scientists learn about health'
            ],
            'capuchin monkey': [
                'Capuchins are one of the smartest monkeys',
                'They use tools to crack nuts',
                'They have very expressive faces',
                'Baby capuchins cling to their mothers'
            ],
            'spider monkey': [
                'Spider monkeys have very long arms',
                'Their tail works like an extra hand',
                'They swing from tree to tree',
                'They rarely come down to the ground'
            ],
            'howler monkey': [
                'Howler monkeys are the loudest land animal!',
                'You can hear them from 3 miles away',
                'They howl to talk to other groups',
                'They eat mostly leaves and fruit'
            ],
            'marmoset': [
                'Marmosets are tiny - they fit in your hand!',
                'They have special claws for climbing',
                'Twin babies are common for marmosets',
                'They communicate with high-pitched calls'
            ],
            'tamarin': [
                'Golden tamarins have beautiful orange fur',
                'They are very rare and precious',
                'They live in the rainforest',
                'Dads help take care of the babies'
            ],
            'proboscis monkey': [
                'Male proboscis monkeys have very big noses!',
                'They are excellent swimmers',
                'They live near rivers in Borneo',
                'Their big nose helps them make loud calls'
            ],
            'monkey': [
                'Monkeys love bananas and other fruits!',
                'Baby monkeys love to play and climb',
                'Monkeys groom each other to stay clean',
                'There are over 260 species of monkeys'
            ]
        };

        // State management
        let imageCount = 0;
        let favoriteCount = 0;
        let usedImageIds = new Set();
        let isLoading = false;
        let imageCache = new Map();
        let favorites = new Set();

        // Load favorites from localStorage
        function loadFavorites() {
            try {
                const saved = localStorage.getItem('monkeyFavorites');
                if (saved) {
                    favorites = new Set(JSON.parse(saved));
                }
            } catch (e) {
                console.error('Failed to load favorites:', e);
            }
        }

        // Save favorites to localStorage
        function saveFavorites() {
            try {
                localStorage.setItem('monkeyFavorites', JSON.stringify([...favorites]));
            } catch (e) {
                console.error('Failed to save favorites:', e);
            }
        }

        // Toast notification system
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            toast.setAttribute('role', 'alert');
            toast.setAttribute('aria-live', 'polite');
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideInUp 0.3s ease-out reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function showLoading(show, text = 'Loading monkey photos...') {
            const loadingDiv = document.getElementById('loadingMessage');
            const loadingText = document.getElementById('loadingText');
            loadingText.textContent = text;

            if (show) {
                loadingDiv.classList.remove('hidden');
            } else {
                loadingDiv.classList.add('hidden');
                updateProgress(0);
            }
        }

        function updateProgress(percent) {
            document.getElementById('progressFill').style.width = `${percent}%`;
        }

        function updateCounter() {
            const galleryImages = document.querySelectorAll('#gallery .image-card').length;
            favoriteCount = favorites.size;
            imageCount = galleryImages;
            document.getElementById('counter').textContent =
                `Images in gallery: ${imageCount} | Favorites: ${favoriteCount}`;

            // Show/hide favorites section
            const favSection = document.getElementById('favoritesSection');
            if (favoriteCount > 0) {
                favSection.style.display = 'block';
            } else {
                favSection.style.display = 'none';
            }
        }

        function getRandomFact(monkeyType) {
            const facts = monkeyFacts[monkeyType] || monkeyFacts['monkey'];
            return facts[Math.floor(Math.random() * facts.length)];
        }

        async function fetchWithRetry(url, retries = 2) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url);
                    if (response.ok) {
                        return await response.json();
                    } else {
                        console.warn(`Fetch attempt ${i + 1} failed with status ${response.status}`);
                        if (i === retries - 1) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                    }
                } catch (error) {
                    console.error(`Fetch attempt ${i + 1} error:`, error);
                    if (i === retries - 1) throw error;
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }
            throw new Error('Failed after retries');
        }

        async function fallbackToPicsumWithMonkeyQuery(monkeyType, displayName) {
            // Use Picsum Photos as last resort - it provides random images
            // Not monkey-specific, but at least something loads
            try {
                const randomId = Math.floor(Math.random() * 1000);
                const imageUrl = `https://picsum.photos/600/400?random=${randomId}`;

                addImageToGallery({
                    id: `picsum-${randomId}`,
                    url: imageUrl,
                    fullUrl: imageUrl,
                    displayName: displayName,
                    monkeyType: monkeyType,
                    photographer: 'Lorem Picsum',
                    source: 'picsum',
                    sourceUrl: 'https://picsum.photos'
                });
                showToast('‚ö†Ô∏è Loaded placeholder image (API keys may need updating)', 'warning');
                return true;
            } catch (error) {
                console.error('Even Picsum failed:', error);
                return false;
            }
        }

        async function loadMonkeyImage(skipLoadingCheck = false) {
            if (!skipLoadingCheck && isLoading) {
                showToast('Please wait for current operation to complete', 'warning');
                return;
            }

            const monkeyType = document.getElementById('monkeyType').value;
            const displayName = document.getElementById('monkeyType').selectedOptions[0].text;

            if (!skipLoadingCheck) {
                isLoading = true;
                showLoading(true);
            }

            let imageLoaded = false;

            try {
                // Try Unsplash first
                const randomPage = Math.floor(Math.random() * 5) + 1;
                const unsplashUrl = `https://api.unsplash.com/search/photos?query=${encodeURIComponent(monkeyType)}&page=${randomPage}&per_page=30&client_id=${CONFIG.unsplashKey}`;

                try {
                    const data = await fetchWithRetry(unsplashUrl);

                    if (data.results && data.results.length > 0) {
                        const availablePhotos = data.results.filter(photo => !usedImageIds.has(photo.id));

                        if (availablePhotos.length > 0) {
                            const photo = availablePhotos[Math.floor(Math.random() * availablePhotos.length)];
                            usedImageIds.add(photo.id);
                            addImageToGallery({
                                id: photo.id,
                                url: photo.urls.regular,
                                fullUrl: photo.urls.full,
                                displayName: displayName,
                                monkeyType: monkeyType,
                                photographer: photo.user.name,
                                source: 'unsplash',
                                sourceUrl: photo.links.html
                            });
                            showToast('Monkey photo loaded successfully!');
                            imageLoaded = true;
                        }
                    }
                } catch (unsplashError) {
                    console.warn('Unsplash failed, trying Pixabay:', unsplashError);
                }

                // If Unsplash didn't work, try Pixabay
                if (!imageLoaded) {
                    const success = await fallbackToPixabay(monkeyType, displayName);
                    if (success) {
                        imageLoaded = true;
                    }
                }

                // If both failed, use placeholder images
                if (!imageLoaded) {
                    console.warn('Both Unsplash and Pixabay failed, using placeholder');
                    const success = await fallbackToPicsumWithMonkeyQuery(monkeyType, displayName);
                    if (success) {
                        imageLoaded = true;
                    }
                }

                if (!imageLoaded) {
                    showToast('Failed to load any images. Check console for details.', 'error');
                }
            } catch (error) {
                console.error('Error loading image:', error);
                if (!skipLoadingCheck) {
                    showToast('Failed to load image. Please try again.', 'error');
                }
            } finally {
                if (!skipLoadingCheck) {
                    isLoading = false;
                    showLoading(false);
                }
            }

            return imageLoaded;
        }

        async function fallbackToPixabay(monkeyType, displayName) {
            try {
                const query = monkeyType === 'monkey' ? 'primate' : monkeyType;
                const pixabayUrl = `https://pixabay.com/api/?key=${CONFIG.pixabayKey}&q=${encodeURIComponent(query)}&image_type=photo&per_page=200`;

                const data = await fetchWithRetry(pixabayUrl);

                if (data.hits && data.hits.length > 0) {
                    const photo = data.hits[Math.floor(Math.random() * data.hits.length)];
                    addImageToGallery({
                        id: `pixabay-${photo.id}`,
                        url: photo.largeImageURL,
                        fullUrl: photo.largeImageURL,
                        displayName: displayName,
                        monkeyType: monkeyType,
                        photographer: photo.user,
                        source: 'pixabay',
                        sourceUrl: photo.pageURL
                    });
                    showToast('Monkey photo loaded successfully!');
                    return true;
                }
                return false;
            } catch (error) {
                console.error('Pixabay fallback failed:', error);
                return false;
            }
        }

        async function loadMultipleImages(types, collectionName) {
            if (isLoading) {
                showToast('Please wait for current operation to complete', 'warning');
                return;
            }

            isLoading = true;
            showLoading(true, `Loading ${collectionName}...`);

            const select = document.getElementById('monkeyType');
            let loaded = 0;

            try {
                // Load images in parallel with staggered starts
                const promises = types.map((type, index) =>
                    new Promise(async (resolve) => {
                        await new Promise(r => setTimeout(r, index * CONFIG.requestDelay));

                        // Set the select value
                        for (let j = 0; j < select.options.length; j++) {
                            if (select.options[j].value === type) {
                                select.selectedIndex = j;
                                break;
                            }
                        }

                        try {
                            const success = await loadMonkeyImage(true); // Skip loading state management
                            if (success) {
                                loaded++;
                            }
                            updateProgress((loaded / types.length) * 100);
                        } catch (error) {
                            console.error('Failed to load image:', error);
                        }
                        resolve();
                    })
                );

                await Promise.all(promises);
                showToast(`${collectionName} loaded! (${loaded}/${types.length} images)`);
            } catch (error) {
                console.error('Error loading collection:', error);
                showToast('Some images failed to load', 'warning');
            } finally {
                isLoading = false;
                showLoading(false);
            }
        }

        async function loadMultipleMonkeys() {
            const types = [
                'macaque',
                'japanese macaque',
                'capuchin monkey',
                'spider monkey',
                'marmoset',
                'monkey'
            ];
            await loadMultipleImages(types, '6 Random Monkeys');
        }

        async function loadMacaqueCollection() {
            const types = [
                'macaque',
                'japanese macaque',
                'rhesus macaque',
                'macaque',
                'japanese macaque'
            ];
            await loadMultipleImages(types, 'Macaque Collection');
        }

        function addImageToGallery(imageData) {
            const gallery = document.getElementById('gallery');
            const card = document.createElement('div');
            card.className = 'image-card';
            card.setAttribute('role', 'listitem');
            card.dataset.imageId = imageData.id;

            const fact = getRandomFact(imageData.monkeyType);
            const isFavorite = favorites.has(imageData.id);

            // Cache the image data
            imageCache.set(imageData.id, imageData);

            card.innerHTML = `
                <img src="${imageData.url}"
                     alt="${imageData.displayName} photographed by ${imageData.photographer}"
                     data-full="${imageData.fullUrl}"
                     tabindex="0"
                     role="button"
                     aria-label="View full size ${imageData.displayName} photo">
                <div class="image-info">
                    <h3>${imageData.displayName}</h3>
                    <div class="fun-fact">${fact}</div>
                    <div style="font-size: 0.8em; color: #999; margin-top: 8px;">
                        Photo by ${imageData.photographer}
                    </div>
                </div>
                <div class="image-actions">
                    <button class="action-btn favorite ${isFavorite ? 'active' : ''}"
                            data-id="${imageData.id}"
                            aria-label="${isFavorite ? 'Remove from favorites' : 'Add to favorites'}"
                            title="${isFavorite ? 'Remove from favorites' : 'Add to favorites'}">
                        ${isFavorite ? '‚òÖ' : '‚òÜ'}
                    </button>
                    <button class="action-btn download"
                            data-url="${imageData.url}"
                            aria-label="Download image"
                            title="Download">
                        ‚¨á
                    </button>
                    <button class="action-btn share"
                            data-url="${imageData.sourceUrl}"
                            aria-label="Share image"
                            title="Share">
                        ‚§¥
                    </button>
                    <button class="action-btn delete"
                            data-id="${imageData.id}"
                            aria-label="Delete image"
                            title="Delete">
                        üóë
                    </button>
                </div>
            `;

            // Add event listeners
            const img = card.querySelector('img');
            img.addEventListener('click', () => openModal(imageData.fullUrl, imageData.displayName));
            img.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    openModal(imageData.fullUrl, imageData.displayName);
                }
            });

            const favoriteBtn = card.querySelector('.favorite');
            favoriteBtn.addEventListener('click', () => toggleFavorite(imageData.id));

            const downloadBtn = card.querySelector('.download');
            downloadBtn.addEventListener('click', () => downloadImage(imageData.url, imageData.displayName));

            const shareBtn = card.querySelector('.share');
            shareBtn.addEventListener('click', () => shareImage(imageData));

            const deleteBtn = card.querySelector('.delete');
            deleteBtn.addEventListener('click', () => deleteImage(imageData.id));

            gallery.insertBefore(card, gallery.firstChild);
            imageCount++;
            updateCounter();
        }

        function toggleFavorite(imageId) {
            if (favorites.has(imageId)) {
                favorites.delete(imageId);
                showToast('Removed from favorites', 'success');
            } else {
                favorites.add(imageId);
                showToast('Added to favorites!', 'success');
            }

            saveFavorites();
            updateFavoriteButtons();
            updateFavoritesGallery();
            updateCounter();
        }

        function updateFavoriteButtons() {
            document.querySelectorAll('.favorite').forEach(btn => {
                const imageId = btn.dataset.id;
                const isFavorite = favorites.has(imageId);
                btn.classList.toggle('active', isFavorite);
                btn.textContent = isFavorite ? '‚òÖ' : '‚òÜ';
                btn.setAttribute('aria-label', isFavorite ? 'Remove from favorites' : 'Add to favorites');
            });
        }

        function updateFavoritesGallery() {
            const favGallery = document.getElementById('favoritesGallery');
            favGallery.innerHTML = '';

            if (favorites.size === 0) {
                updateCounter();
                return;
            }

            favorites.forEach(imageId => {
                const imageData = imageCache.get(imageId);
                if (imageData) {
                    const card = createFavoriteCard(imageData);
                    favGallery.appendChild(card);
                }
            });

            updateCounter();
        }

        function createFavoriteCard(imageData) {
            const card = document.createElement('div');
            card.className = 'image-card';
            card.setAttribute('role', 'listitem');

            const fact = getRandomFact(imageData.monkeyType);

            card.innerHTML = `
                <img src="${imageData.url}"
                     alt="${imageData.displayName} photographed by ${imageData.photographer}"
                     data-full="${imageData.fullUrl}"
                     tabindex="0"
                     role="button"
                     aria-label="View full size ${imageData.displayName} photo">
                <div class="image-info">
                    <h3>${imageData.displayName}</h3>
                    <div class="fun-fact">${fact}</div>
                    <div style="font-size: 0.8em; color: #999; margin-top: 8px;">
                        Photo by ${imageData.photographer}
                    </div>
                </div>
                <div class="image-actions">
                    <button class="action-btn favorite active"
                            data-id="${imageData.id}"
                            aria-label="Remove from favorites"
                            title="Remove from favorites">
                        ‚òÖ
                    </button>
                    <button class="action-btn download"
                            data-url="${imageData.url}"
                            aria-label="Download image"
                            title="Download">
                        ‚¨á
                    </button>
                    <button class="action-btn share"
                            data-url="${imageData.sourceUrl}"
                            aria-label="Share image"
                            title="Share">
                        ‚§¥
                    </button>
                </div>
            `;

            const img = card.querySelector('img');
            img.addEventListener('click', () => openModal(imageData.fullUrl, imageData.displayName));
            img.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    openModal(imageData.fullUrl, imageData.displayName);
                }
            });

            const favoriteBtn = card.querySelector('.favorite');
            favoriteBtn.addEventListener('click', () => toggleFavorite(imageData.id));

            const downloadBtn = card.querySelector('.download');
            downloadBtn.addEventListener('click', () => downloadImage(imageData.url, imageData.displayName));

            const shareBtn = card.querySelector('.share');
            shareBtn.addEventListener('click', () => shareImage(imageData));

            return card;
        }

        async function downloadImage(url, name) {
            try {
                const response = await fetch(url);
                const blob = await response.blob();
                const blobUrl = window.URL.createObjectURL(blob);

                const link = document.createElement('a');
                link.href = blobUrl;
                link.download = `${name.replace(/\s+/g, '-').toLowerCase()}-${Date.now()}.jpg`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                window.URL.revokeObjectURL(blobUrl);
                showToast('Download started!', 'success');
            } catch (error) {
                console.error('Download failed:', error);
                showToast('Download failed. Please try again.', 'error');
            }
        }

        async function shareImage(imageData) {
            const shareData = {
                title: `${imageData.displayName} Photo`,
                text: `Check out this amazing ${imageData.displayName} photo!`,
                url: imageData.sourceUrl
            };

            try {
                if (navigator.share) {
                    await navigator.share(shareData);
                    showToast('Shared successfully!', 'success');
                } else {
                    // Fallback: copy link to clipboard
                    await navigator.clipboard.writeText(imageData.sourceUrl);
                    showToast('Link copied to clipboard!', 'success');
                }
            } catch (error) {
                if (error.name !== 'AbortError') {
                    console.error('Share failed:', error);
                    showToast('Share failed. Link copied to clipboard.', 'warning');
                    try {
                        await navigator.clipboard.writeText(imageData.sourceUrl);
                    } catch (e) {
                        console.error('Clipboard failed:', e);
                    }
                }
            }
        }

        function deleteImage(imageId) {
            const cards = document.querySelectorAll(`.image-card[data-image-id="${imageId}"]`);
            cards.forEach(card => {
                card.style.animation = 'slideIn 0.3s ease-out reverse';
                setTimeout(() => {
                    card.remove();
                    imageCount--;
                    updateCounter();
                }, 300);
            });

            // Remove from favorites if present
            if (favorites.has(imageId)) {
                favorites.delete(imageId);
                saveFavorites();
                updateFavoritesGallery();
            }

            showToast('Image deleted', 'success');
        }

        function clearGallery() {
            if (imageCount === 0) {
                showToast('Gallery is already empty', 'warning');
                return;
            }

            if (confirm(`Clear all ${imageCount} monkey photos?`)) {
                document.getElementById('gallery').innerHTML = '';
                imageCount = 0;
                usedImageIds.clear();
                updateCounter();
                showToast('Gallery cleared', 'success');
            }
        }

        function openModal(src, altText) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            modal.classList.add('active');
            modalImg.src = src;
            modalImg.alt = `Full size ${altText}`;
            document.body.style.overflow = 'hidden';

            // Focus on close button for accessibility
            document.getElementById('closeModalBtn').focus();
        }

        function closeModal() {
            const modal = document.getElementById('imageModal');
            modal.classList.remove('active');
            document.body.style.overflow = 'auto';

            // Exit fullscreen if active
            if (document.fullscreenElement) {
                document.exitFullscreen();
            }
        }

        function toggleFullscreen() {
            const modal = document.getElementById('imageModal');

            if (!document.fullscreenElement) {
                modal.requestFullscreen().catch(err => {
                    showToast('Fullscreen failed', 'error');
                });
            } else {
                document.exitFullscreen();
            }
        }

        // Event listeners
        document.getElementById('loadSingleBtn').addEventListener('click', loadMonkeyImage);
        document.getElementById('loadMultipleBtn').addEventListener('click', loadMultipleMonkeys);
        document.getElementById('loadCollectionBtn').addEventListener('click', loadMacaqueCollection);
        document.getElementById('clearGalleryBtn').addEventListener('click', clearGallery);

        // Modal controls
        document.getElementById('imageModal').addEventListener('click', (e) => {
            if (e.target.id === 'imageModal') {
                closeModal();
            }
        });

        document.getElementById('closeModalBtn').addEventListener('click', (e) => {
            e.stopPropagation();
            closeModal();
        });

        document.getElementById('fullscreenBtn').addEventListener('click', (e) => {
            e.stopPropagation();
            toggleFullscreen();
        });

        // Keyboard navigation
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeModal();
            }
        });

        // Initialize
        window.addEventListener('load', function() {
            loadFavorites();
            updateFavoritesGallery();

            setTimeout(() => {
                document.getElementById('monkeyType').value = 'japanese macaque';
                loadMonkeyImage();
            }, 500);
        });
    </script>
</body>
</html>
